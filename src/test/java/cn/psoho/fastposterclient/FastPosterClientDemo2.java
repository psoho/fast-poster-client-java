package cn.psoho.fastposterclient;import java.util.HashMap;import com.alibaba.fastjson.JSON;import com.alibaba.fastjson.JSONObject;import okhttp3.*;import org.apache.commons.io.FileUtils;import java.io.File;import java.io.IOException;import java.util.Map;import java.util.concurrent.TimeUnit;public class FastPosterClientDemo2 {    public static void main(String[] args) {        // 创建海报客户端对象        PosterClient posterClient = new PosterClient("http://localhost:5000/", "6e51837fabcd720c5dc4e18cfd8bde1b");        // 构造海报参数        HashMap<String, String> params = new HashMap<>();        params.put("avatar", "https://poster.prodapi.cn/static/images/xiaoniu.png");        params.put("img1", "https://poster.prodapi.cn/static/images/xiaoniu.pngx");        params.put("qrcode", "https://poster.prodapi.cn/");        params.put("text1", "请输入文字222222");        // 海报ID        String posterId = "10004";        // 获取下载地址        String url = posterClient.getUrl(posterId, params);        System.out.println("url=" + url);        // 保存到本地        posterClient.saveToPath(url, "temp.png");    }}class PosterClient {    final static OkHttpClient okHttpClient = new OkHttpClient.Builder().connectTimeout(6, TimeUnit.SECONDS).build();    private static final String USER_AGENT = "fastposter-pro-client/v1.0.0";    /**     * 接入点     */    private String endpoint;    /**     * 访问KEY     */    private String token;    public PosterClient(String endpoint, String token) {        this.token = token;        endpoint = endpoint.trim();        if (endpoint.endsWith("/")) {            endpoint = endpoint.substring(0, endpoint.length() - 1);        }        this.endpoint = endpoint;    }    /**     * 获取海报访问地址     *     * @param posterId 海报ID     * @param params   参数列表     * @return String     */    public String getUrl(String posterId, Map<String, String> params) {        if (params == null) {            params = new HashMap<>();        }        params.put("id", posterId);        String url = this.endpoint + "/api/link";        MediaType mediaType = MediaType.parse("application/json");        String json = JSON.toJSONString(params, true);        RequestBody body = RequestBody.create(mediaType, json);        Request request = new Request.Builder()                .url(url)                .post(body)                .addHeader("User-Agent", USER_AGENT)                .addHeader("Content-Type", "application/json")                .addHeader("token", this.token)                .addHeader("cache-control", "no-cache")                .build();        try {            Response response = okHttpClient.newCall(request).execute();            String jsonR = response.body().string();            JSONObject o = JSONObject.parseObject(jsonR);            System.out.println(o);            if (o.getInteger("code") == 0) {                JSONObject d = o.getJSONObject("data");                url = d.getString("url");            } else {                throw new RuntimeException("获取海报链接异常: " + o.getString("msg"));            }            return url.startsWith("http") ? url : endpoint + "/" + url;        } catch (IOException e) {            throw new RuntimeException("获取海报链接异常", e);        }    }    /**     * 获取海报数据     *     * @param url     * @return     */    public byte[] getData(String url) {        try {            Request request = new Request.Builder()                    .url(url)                    .addHeader("User-Agent", USER_AGENT)                    .get()                    .build();            Response response = okHttpClient.newCall(request).execute();            return response.body().bytes();        } catch (Exception e) {            throw new RuntimeException("获取海报数据异常", e);        }    }    /**     * 保存海报到文件     *     * @param url     * @param path     */    public void saveToPath(String url, String path) {        try {            byte[] data = getData(url);            FileUtils.writeByteArrayToFile(new File(path), data);        } catch (IOException e) {            new RuntimeException("保存海报到文件", e);        }    }}